app.controller('RecipeFinderCtrl', ['$scope', '$http', '$routeParams', 'TagServices', 'UserServices', function($scope, $http, $routeParams, TagServices, UserServices){

  // search_parameters
  $scope.search_parameters = {};
  $scope.search_parameters.categories = [];
  $scope.search_parameters.ingredients = [];
  $scope.search_parameters.keywords = [];
  $scope.search_parameters.timeframe = [0,1440];

  // data to populate recipe finder
  $scope.meals = TagServices.meals
  $scope.cuisines = TagServices.cuisines
  $scope.cuisine_hidden = TagServices.cuisine_hidden
  $scope.courses = TagServices.courses
  $scope.courses_hidden = TagServices.courses_hidden
  $scope.occasions = TagServices.occasions
  $scope.occasions_hidden = TagServices.occasions_hidden

  // paginate varibales
  $scope.maxSize = 5;
  $scope.bigTotalItems = 1;
  $scope.bigCurrentPage = 1;
  $scope.chefLoadingImg = "<%= asset_path('chef-loading.gif') %>"
  $scope.defaultImg = "<%= asset_path('recipedb-default-img.png') %>"

  var getFilteredRecipes = function(params){
    $scope.loading = true;
    $http.post('/recipes/search', params).success(function(data, status){
      $scope.recipes = data.recipes;
      UserServices.main.recipes = data.recipes;
      $scope.loading = false;
      if ($(".hide-finder-button").attr('data-status') == 'closed'){
        // console.log("hihi");
      }
    })
  }

  var getFilteredRecipesCount = function(params){
    $http.post('/recipes/search_count', params).success(function(data, status){
      $scope.bigTotalItems = data.count;
      UserServices.main.totalItems = data.count;
    })
  };

  $scope.pageChanged = function() {
    UserServices.main.search_parameters = $scope.search_parameters;
    UserServices.main.page = $scope.bigCurrentPage;
    UserServices.activateSearch = true;
    getFilteredRecipes(UserServices.main);
  };

  $scope.submitParams = function(){
    UserServices.main.search_parameters = $scope.search_parameters;
    UserServices.main.page = 1;
    UserServices.activateSearch = true;
    getFilteredRecipesCount(UserServices.main);
    getFilteredRecipes(UserServices.main);
  }

  $scope.memorySearch = function(){
    $scope.search_parameters = UserServices.main.search_parameters;
    $scope.bigCurrentPage = UserServices.main.page;
    $scope.recipes = UserServices.main.recipes;
    $scope.bigTotalItems = UserServices.main.totalItems
    $scope.bigCurrentPage = UserServices.main.page
  }

  $scope.freshSearch = function(){
    getFilteredRecipesCount(UserServices.main);
    getFilteredRecipes(UserServices.main);
  }

  if (UserServices.activateSearch){
    if (UserServices.freshSearch){
      $scope.freshSearch();
      UserServices.freshSearch = false;
    } else {
      $scope.memorySearch();
    }
  } else {
    $scope.submitParams();
  }

  // toggle hidden checkboxes
  var collapseAll = function() {
    $scope.cuisineCollapsed = true;
    $scope.courseCollapsed = true;
    $scope.occasionCollapsed = true;
  }
  collapseAll();

  // add to collection button
  $scope.addCollection = function(recipeID) {
    console.log(recipeID);
    $http.post('/user/' + UserServices.userID + '/bookmarks/', recipeID).success(function(data, status){
      // console.log('data');

    });
  };

  // reset finder button
  $scope.resetFinder = function() {
    $('.checkbox').prop('checked',false);
    $scope.search_parameters.categories = [];
    $scope.search_parameters.keywords = [];
    $scope.search_parameters.ingredients = [];
    $scope.search_parameters.timeframe = [0,1440];
    $(".ui-slider-range.ui-widget-header.ui-corner-all").attr("style","left: 0%;width: 100%;");
    $($(".ui-slider-handle.ui-state-default.ui-corner-all")[0]).attr("style","left: 0%;");
    $($(".ui-slider-handle.ui-state-default.ui-corner-all")[1]).attr("style","left: 100%;");
    $("#amount").val(timeConversion(0) + " to " + timeConversion(1440) );
    collapseAll();
    $scope.submitParams();
  }

  $scope.hidden = false;
  // $scope.togglehider = function() {
  //     $scope.hider = $scope.hider === false ? true: false;
  // };

  // keyword search
  var checkDuplicates = function(keyword,array) {
    for (var i = 0; i < array.length; i++) {
      if (keyword == array[i]) {
        return true;
      }
    }
  };

  $scope.searchWord = "Ingredient";

  $scope.addKeyword = function() {
    if ($scope.newKeyword != undefined && $scope.newKeyword != "" && $scope.newKeyword.length > 2) {
      if (checkDuplicates($scope.newKeyword,$scope.search_parameters.keywords) == true || checkDuplicates($scope.newKeyword, $scope.search_parameters.ingredients) == true) {
        $scope.newKeyword = '';
        // need noty
      } else {
        if ($scope.searchWord == "Ingredient") {
          $scope.search_parameters.ingredients.push($scope.newKeyword);
          $scope.newKeyword = '';
        } else if ($scope.searchWord == "Keyword") {
          $scope.search_parameters.keywords.push($scope.newKeyword);
          $scope.newKeyword = '';
        } 
        $scope.submitParams();
      }
    } else {
      $scope.newKeyword = '';
      // needs notification of empty string
    }
  }
  $scope.removeKeyword = function(index) {
    $scope.search_parameters.keywords.splice(index,1);
    $scope.submitParams();
  }
  $scope.removeIngredient = function(index) {
    $scope.search_parameters.ingredients.splice(index,1);
    $scope.submitParams();
  }

  // toggle selection for a given food by name
  $scope.toggleCategory = function (category) {
    var idx = $scope.search_parameters.categories.indexOf(category);
    // is currently selected
    if (idx > -1) {
      $scope.search_parameters.categories.splice(idx, 1);
    } else {
      $scope.search_parameters.categories.push(category);
    }
    $scope.submitParams();
  };

  // time slider function
  $scope.search_parameters.timeframe = [0,1440];


  var timeConversion = function(minutes) {
    if (minutes > 60) {
      return Math.floor(minutes / 60) + "hr " + minutes % 60 + "min";
    } else {
      return minutes + "min";
    }
  }

  $(function() {
    $( "#slider-range" ).slider({
      range: true,
      min: 0,
      max: 1440,
      values: [ 0, 1440 ],
      slide: function(event,ui) {

        $("#amount").val(timeConversion(ui.values[0]) + " to " + timeConversion(ui.values[1]));

        $scope.search_parameters.timeframe = ui.values;
        $scope.submitParams();
      }
    });
    // initial slider values
    // $( "#amount" ).val( $( "#slider-range" ).slider( "values", 0 ) + " - " + $( "#slider-range" ).slider( "values", 1 ) +" mins" );
    $("#amount").val(timeConversion(0) + " to " + timeConversion(1440) );
  });
}]);
